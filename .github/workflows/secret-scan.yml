# GitHub Actions Workflow: Secret Scanning
# Part of ralph-gold security enhancements (2026-01-20)
#
# This workflow runs gitleaks on every push and pull request to detect
# accidental secret commits. It provides defense-in-depth alongside the
# pre-commit hook, catching secrets that bypass local checks.
#
# Reference: .spec/spec-2026-01-20-security-enhancements-resolution.md

name: Secret Scanning

on:
  # Scan on pushes to main branches
  push:
    branches: [main, master, develop]

  # Scan on pull requests to main branches
  pull_request:
    branches: [main, master, develop]

  # Allow manual workflow trigger
  workflow_dispatch:

# Prevent duplicate workflow runs
concurrency:
  group: secret-scan-${{ github.ref }}
  cancel-in-progress: true

jobs:
  gitleaks:
    name: Scan for Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          # Critical: fetch full history for comprehensive scanning
          fetch-depth: 0

      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Gitleaks configuration (relative to repo root)
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Optional: for Enterprise features

      # Optional: Upload scan results as artifacts for review
      - name: Upload Report
        if: always()
        uses: actions/upload-artifact@v7
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 30
