# Project Structure & Directory Lifecycle

**Version:** 1.0
**Last Updated:** 2026-01-20
**Review Cadence:** Quarterly
**Audience:** Contributors and advanced users

---

## Purpose

Define the Ralph Gold repository layout and the scaffolding generated by `ralph init`, including file lifecycles and usage patterns.

---

## Repository Layout (source-of-truth)

```
.
â”œâ”€ src/ralph_gold/        # Core library + CLI implementation
â”œâ”€ tests/                # Pytest suite
â”œâ”€ docs/                 # User and contributor documentation
â”œâ”€ scripts/              # Helper scripts
â”œâ”€ vscode/ralph-bridge/   # VS Code bridge extension
â”œâ”€ .ralph/               # Loop config/state for this repo (local)
â””â”€ ...
```

### Core Code

- `src/ralph_gold/`: CLI, orchestration logic, and supporting modules.
- `src/ralph_gold/templates/`: scaffolding templates used by `ralph init`.
- `src/ralph_gold/scaffold.py`: orchestration for generating the scaffolded files.

### Documentation

- `docs/`: product docs, usage guides, and protocol references.
- `docs/assets/`: images and other documentation assets.

---

## `.ralph/` Directory Structure

`ralph init` creates a `.ralph/` directory with this structure:

```
.ralph/
â”œâ”€â”€ ralph.toml                 # Configuration file
â”œâ”€â”€ PRD.md                     # Task tracker (Markdown)
â”œâ”€â”€ AGENTS.md                  # Repo-specific commands
â”œâ”€â”€ progress.md                # Append-only progress log
â”œâ”€â”€ FEEDBACK.md                # Operator feedback and review notes
â”œâ”€â”€ PROMPT_build.md            # Build iteration prompt
â”œâ”€â”€ PROMPT_plan.md             # Planning prompt
â”œâ”€â”€ PROMPT_judge.md            # Judge gate prompt
â”œâ”€â”€ PROMPT_review.md           # Review gate prompt
â”œâ”€â”€ specs/                     # Requirements specifications
â”‚   â””â”€â”€ *.md                   # Individual spec files
â”œâ”€â”€ templates/                 # Custom task templates
â”‚   â””â”€â”€ *.json                 # Template definitions
â”œâ”€â”€ permissions.json           # Optional authorization rules
â”œâ”€â”€ state.json                 # Session state (machine-readable)
â”œâ”€â”€ logs/                      # Per-iteration agent logs
â”‚   â””â”€â”€ iteration-*.log        # Timestamped log files
â”œâ”€â”€ receipts/                  # Execution receipts
â”‚   â”œâ”€â”€ command-*.json         # Command receipts
â”‚   â””â”€â”€ evidence-*.json        # Evidence citations
â”œâ”€â”€ context/                   # Context snapshots
â”‚   â””â”€â”€ <iteration>/           # Per-iteration snapshots
â”‚       â””â”€â”€ ANCHOR.md          # Anchor context file
â”œâ”€â”€ attempts/                  # Task attempt records
â”‚   â””â”€â”€ <task-id>/             # Per-task attempt directories
â”‚       â””â”€â”€ attempt-*.json     # Attempt records
â”œâ”€â”€ snapshots/                 # Git-based snapshots
â”‚   â””â”€â”€ *.json                 # Snapshot metadata
â””â”€â”€ worktrees/                 # Parallel execution worktrees
    â””â”€â”€ <task-id>/             # Per-task git worktrees
```

---

`â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`
**Directory Lifecycle Patterns:**
1. **Growing directories** - `logs/`, `receipts/`, `context/` grow with iterations
2. **Rotating content** - `attempts/` is pruned based on `state.cleanup_stale_tasks`
3. **User-managed** - `specs/`, `templates/` are primarily user-editable
4. **Transient** - `worktrees/` are temporary and removed after merge
`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`

---

## File Lifecycles

### Configuration Files (User-Managed)

| File | Created | Modified | Purpose |
|------|---------|----------|---------|
| `ralph.toml` | `ralph init` | User | Loop configuration |
| `permissions.json` | User | User | Authorization rules (optional) |
| `templates/*.json` | User | User | Custom task templates |

**Lifecycle:** Persist until manually deleted or re-init with `--force`.

---

### Task Tracking Files (User + Agent)

| File | Created | Modified By | Purpose |
|------|---------|-------------|---------|
| `PRD.md` | `ralph init` | Agent | Task list and completion |
| `progress.md` | `ralph init` | Agent | Append-only progress log |
| `state.json` | First iteration | Ralph | Machine-readable state |

**Lifecycles:**

- **PRD.md**: Updated by agents to mark tasks complete. Can be manually edited.
- **progress.md**: Append-only log. Grows with each successful iteration.
- **state.json**: Overwritten on each iteration. Tracks task IDs, attempts, history.

---

### Prompt Templates (User-Managed)

| File | Purpose | Edit Frequency |
|------|---------|---------------|
| `PROMPT_build.md` | Build iteration prompt | Low |
| `PROMPT_plan.md` | Planning prompt | Low |
| `PROMPT_judge.md` | Judge gate prompt | Low |
| `PROMPT_review.md` | Review gate prompt | Low |
| `AGENTS.md` | Repo commands | Medium |

**Lifecycle:** Edit as needed to customize agent behavior. Templates are preserved on `ralph init --force`.

---

### Run Artifacts (Agent-Generated)

#### `logs/` Directory

**Pattern:** `logs/iteration-<timestamp>-iter<N>.log`

**Created:** Each iteration
**Content:** Full agent output (stdout + stderr)
**Retention:** Manual cleanup via `ralph clean --logs`
**Size:** ~1-10MB per iteration

**Example lifecycle:**
```
1. ralph run starts
2. Iteration 1: logs/iteration-20260120-120000-iter0001.log created
3. Iteration 2: logs/iteration-20260120-120500-iter0002.log created
4. ralph clean --logs removes old logs
```

#### `receipts/` Directory

**Pattern:** `receipts/command-<attempt_id>.json`, `receipts/evidence-<attempt_id>.json`

**Created:** Each iteration attempt
**Content:** Structured execution receipts
**Retention:** Manual cleanup
**Size:** ~1-5KB per receipt

**Receipt types:**
- `command-*.json`: Command execution records (agent, gates, etc.)
- `evidence-*.json`: Evidence citations extracted from agent output

#### `context/` Directory

**Pattern:** `context/<iteration_number>/ANCHOR.md`

**Created:** Each iteration
**Content:** Context snapshot (anchor file) with optional RepoPrompt pack
**Retention:** Manual cleanup
**Size:** ~10-100KB per snapshot

**Purpose:** Provides reproducible context for each iteration. Used for debugging and auditing.

#### `attempts/` Directory

**Pattern:** `attempts/<task_id>/attempt-<timestamp>.json`

**Created:** Each task attempt
**Content:** Attempt metadata (start time, end time, result, logs path)
**Retention:** Controlled by `state.auto_cleanup_stale` config
**Size:** ~1KB per attempt

**Cleanup behavior:**
- Current task always protected (`state.protect_current_task = true`)
- Recently completed tasks protected (`state.protect_recent_hours = 1`)
- Stale tasks removed if `state.auto_cleanup_stale = true`

---

### Optional Directories

#### `specs/` Directory

**Pattern:** `specs/*.md`

**Created:** `ralph init` creates empty directory
**Content:** Requirement specifications (user-created)
**Usage:** Referenced in prompts via `prompt.max_specs_files` limit
**Retention:** User-managed

**Purpose:** Stores detailed requirements that agents reference during planning and implementation.

#### `templates/` Directory

**Pattern:** `templates/*.json`

**Created:** User creates
**Content:** Custom task templates
**Usage:** `ralph task add --template <name>`
**Retention:** User-managed

**Purpose:** Define reusable task templates with acceptance criteria.

#### `snapshots/` Directory

**Pattern:** `snapshots/<snapshot-name>/metadata.json`

**Created:** `ralph snapshot <name>`
**Content:** Git stash references and Ralph state backups
**Usage:** `ralph rollback <name>`
**Retention:** User-managed cleanup

**Purpose:** Safe rollback points before risky changes.

#### `worktrees/` Directory

**Pattern:** `worktrees/<task_id>/`

**Created:** Parallel execution (if enabled)
**Content:** Git worktrees for parallel task execution
**Usage:** Automatic creation/removal by parallel system
**Retention:** Removed after merge or on cleanup

**Purpose:** Isolated workspaces for parallel task execution.

---

## File Creation Timeline

### First `ralph init`

```
.ralph/
â”œâ”€â”€ ralph.toml          âœ… Created (config)
â”œâ”€â”€ PRD.md              âœ… Created (empty template)
â”œâ”€â”€ AGENTS.md           âœ… Created (template)
â”œâ”€â”€ progress.md         âœ… Created (empty)
â”œâ”€â”€ FEEDBACK.md         âœ… Created (empty)
â”œâ”€â”€ PROMPT_*.md         âœ… Created (templates)
â”œâ”€â”€ specs/              âœ… Created (empty dir)
â”œâ”€â”€ templates/          âœ… Created (empty dir)
â””â”€â”€ state.json          âŒ Not yet (created on first run)
```

### After First Iteration

```
.ralph/
â”œâ”€â”€ state.json          âœ… Created
â”œâ”€â”€ logs/               âœ… Created (dir)
â”‚   â””â”€â”€ iteration-*.log âœ… Created
â”œâ”€â”€ receipts/           âœ… Created (dir)
â”‚   â”œâ”€â”€ command-*.json  âœ… Created
â”‚   â””â”€â”€ evidence-*.json âœ… Created (if evidence found)
â”œâ”€â”€ context/            âœ… Created (dir)
â”‚   â””â”€â”€ 1/ANCHOR.md     âœ… Created
â””â”€â”€ attempts/           âœ… Created (dir)
    â””â”€â”€ <task-id>/      âœ… Created
        â””â”€â”€ attempt-*.json âœ… Created
```

### After N Iterations

```
.ralph/
â”œâ”€â”€ PRD.md              ğŸ”„ Updated (tasks marked complete)
â”œâ”€â”€ progress.md         ğŸ”„ Appended (progress logs)
â”œâ”€â”€ state.json          ğŸ”„ Overwritten (each iteration)
â”œâ”€â”€ logs/               ğŸ“Š Grows (N log files)
â”œâ”€â”€ receipts/           ğŸ“Š Grows (2N receipt files)
â”œâ”€â”€ context/            ğŸ“Š Grows (N directories)
â””â”€â”€ attempts/           ğŸ“Š Grows (varies by retries)
```

---

## Cleanup Commands

### Remove Old Logs

```bash
ralph clean --logs
```

Removes log files older than 7 days.

### Remove Old Archives

```bash
ralph clean --archives
```

Removes archived `.ralph/` directories from `ralph init --force`.

### Remove All Artifacts

```bash
ralph clean --all
```

Removes logs, archives, and other temporary artifacts.

### Manual Cleanup

```bash
# Remove specific artifact types
rm -rf .ralph/logs/*
rm -rf .ralph/receipts/*
rm -rf .ralph/context/*
```

---

## State File Schema

`state.json` contains:

```json
{
  "version": "1.0",
  "task_id": "1",
  "task_title": "Example task",
  "iteration": 5,
  "start_time": "2026-01-20T12:00:00Z",
  "last_update": "2026-01-20T12:30:00Z",
  "history": [
    {
      "iteration": 1,
      "timestamp": "2026-01-20T12:00:00Z",
      "task_id": "1",
      "progress_made": true,
      "return_code": 0
    }
  ],
  "tasks": {
    "1": {
      "id": "1",
      "title": "Example task",
      "completed": false,
      "attempts": 3
    }
  }
}
```

---

## Common Operations

### View Current State

```bash
# Human-readable status
ralph status

# Machine-readable state
cat .ralph/state.json | jq .

# Progress log
cat .ralph/progress.md

# Task list
cat .ralph/PRD.md
```

### Inspect Artifacts

```bash
# Latest log
cat .ralph/logs/$(ls -t .ralph/logs/ | head -1)

# Latest evidence
jq . .ralph/receipts/evidence-$(ls -t .ralph/receipts/evidence-*.json | head -1 | sed 's/.*evidence-//' | sed 's/\.json//')

# Context snapshot
cat .ralph/context/1/ANCHOR.md
```

### Reinitialize

```bash
# Safe reinit (merges config)
ralph init

# Force reinit (archives existing)
ralph init --force
```

---

## Parallel Execution Directories

When parallel execution is enabled:

```
.ralph/
â””â”€â”€ worktrees/
    â”œâ”€â”€ task-1/           # Git worktree for task 1
    â”‚   â””â”€â”€ .git          # Worktree gitdir
    â””â”€â”€ task-2/           # Git worktree for task 2
        â””â”€â”€ .git          # Worktree gitdir
```

**Lifecycle:**
1. Created when parallel task starts
2. Used for isolated development
3. Removed after merge or on cleanup

**See also:** `docs/PARALLEL_CONFIG.md`

---

## Troubleshooting

### State Out of Sync

**Symptom:** `ralph status` shows wrong task

**Solution:**
```bash
# Validate state
ralph diagnose

# Or reset state (careful!)
rm .ralph/state.json
```

### Missing Context Snapshots

**Symptom:** `context/` directory missing or empty

**Solution:** Context is created each iteration. Run one iteration to generate:
```bash
ralph step --agent codex
```

### Large Disk Usage

**Symptom:** `.ralph/` directory is large

**Solution:**
```bash
# Check size
du -sh .ralph/

# Clean old logs
ralph clean --logs

# Clean old archives
ralph clean --archives

# Or manually clean
rm -rf .ralph/logs/*
rm -rf .ralph/context/*
```

---

## Smoke Test

Run the CLI help to confirm the entrypoint is wired:

```bash
uv run python -m ralph_gold.cli --help
```

---

## Where To Add New Work

- Core features: `src/ralph_gold/`
- Tests: `tests/`
- Docs: `docs/`
- VS Code bridge changes: `vscode/ralph-bridge/`

---

**Document Owner:** maintainers
**Next Review:** 2026-04-20
**Change Log:**
- 2026-01-20: Initial version (v1.0) - Expanded from original with lifecycle details
